mutate(cc = "RSpé", caisse = "Régimes spéciaux (SNCF, RATP, CNIEG, CRPCEN)", source = "Recalculé") %>%
group_by(cc,caisse,source,sexe,naiss,generation,annee,age) %>%
summarise(ageliq = weighted.mean(ageliq,w=effectifs),
effectifs = sum(effectifs),
nbreg = n()) %>%
filter(nbreg == 4) %>%
ungroup(),
# régimes d'indépendants (hors PL)
tabc %>% filter(cc %in% c("0022","0040","0050","0042") & annee>=2015 & annee<=2019) %>%
mutate(cc = "Indp", caisse = "Indépendants (hors libéraux)", source = "Recalculé") %>%
group_by(cc,caisse,source,sexe,naiss,generation,annee,age) %>%
summarise(ageliq = weighted.mean(ageliq,w=effectifs),
effectifs = sum(effectifs),
nbreg = n()) %>%
filter(nbreg %in% c(2,3) ) %>%
ungroup()
)  %>%
select(-effectifs, -nbreg)
vargen <- tabc %>% select(-annee,-source) %>%
left_join(tabc %>% select(caisse,cc,sexe,naiss,age,generation,ageliq) %>%
mutate(generation=generation-1) %>%
rename(ageliq_g_p1 = ageliq),
by=c("caisse","cc","sexe","naiss","age","generation")) %>%
mutate(varageliq_g_p1=ageliq/ageliq_g_p1) %>%
filter(!is.na(varageliq_g_p1))
effets <- vargen %>%
mutate(lvarage = log(varageliq_g_p1),
annee = factor(generation+age),
generation = factor(generation)) %>%
filter(!is.na(lvarage)) %>%
group_by(cc,sexe,naiss) %>%
filter( NROW(unique(annee))>1 & NROW(unique(generation))>1 )  %>%
ungroup() %>%
nest_by(cc,sexe,naiss) %>%
mutate(model = list(lm(lvarage ~ annee + generation, data=data) ) )
reg <- "0010"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
reg <- "0015"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
reg <- "6000"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
reg <- "5000"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
reg <- "5600"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
reg <- "0021"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
reg <- "0012"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
quantiles_effetsannnee <- coeff_effets %>%
group_by(cc,naiss,sexe) %>%
nest() %>%
mutate(
ret = map(data,~quantile(x=.$estimate, probs = seq(0.25,0.5,0.75) )),
ret = invoke_map(data.frame, ret)
) %>%
unnest(ret) %>% ungroup() %>%
select(-data) %>%
janitor::clean_names()
View(quantiles_effetsannnee)
quantiles_effetsannnee <- coeff_effets %>%
group_by(cc,naiss,sexe) %>%
nest() %>%
mutate(
ret = map(data,~quantile(x=.$estimate, probs = c(0.25,0.5,0.75) )),
ret = invoke_map(data.frame, ret)
) %>%
unnest(ret) %>% ungroup() %>%
select(-data) %>%
janitor::clean_names()
View(quantiles_effetsannnee)
View(quantiles_effetsannnee)
pb_effetsannee <- coeff_effets %>%
left_join(quantiles_effetsannee, by=c("cc","naiss","sexe")) %>%
filter(estimate < x50-2*(x75-x25) | estimate > x50+2*(x75-x25)) %>%
distinct(cc,naiss,sexe)
quantiles_effetsannee <- coeff_effets %>%
group_by(cc,naiss,sexe) %>%
nest() %>%
mutate(
ret = map(data,~quantile(x=.$estimate, probs = c(0.25,0.5,0.75) )),
ret = invoke_map(data.frame, ret)
) %>%
unnest(ret) %>% ungroup() %>%
select(-data) %>%
janitor::clean_names()
pb_effetsannee <- coeff_effets %>%
left_join(quantiles_effetsannee, by=c("cc","naiss","sexe")) %>%
filter(estimate < x50-2*(x75-x25) | estimate > x50+2*(x75-x25)) %>%
distinct(cc,naiss,sexe)
View(coeff_effets)
View(pb_effetsannee)
pb_effetsannee <- coeff_effets %>%
left_join(quantiles_effetsannee, by=c("cc","naiss","sexe")) %>%
filter(estimate < x50-2*(x75-x25) | estimate > x50+2*(x75-x25)) %>%
distinct(cc,naiss,sexe,annee)
pb_effetsannee <- coeff_effets %>%
left_join(quantiles_effetsannee, by=c("cc","naiss","sexe")) %>%
filter(estimate < x50-2*(x75-x25) | estimate > x50+2*(x75-x25))
View(pb_effetsannee)
pb_effetsannee <- coeff_effets %>%
left_join(quantiles_effetsannee, by=c("cc","naiss","sexe")) %>%
filter(estimate < x50-2*(x75-x25) | estimate > x50+2*(x75-x25)) %>%
rename(annee=valeur) %>%
distinct(cc,naiss,sexe,annee)
View(pb_effetsannee)
quantiles_effetsannee <- coeff_effets %>% filter(type=="annee") %>%
group_by(cc,naiss,sexe) %>%
nest() %>%
mutate(
ret = map(data,~quantile(x=.$estimate, probs = c(0.25,0.5,0.75) )),
ret = invoke_map(data.frame, ret)
) %>%
unnest(ret) %>% ungroup() %>%
select(-data) %>%
janitor::clean_names()
pb_effetsannee <- coeff_effets %>%
filter(type=="annee") %>%
left_join(quantiles_effetsannee, by=c("cc","naiss","sexe")) %>%
filter(estimate < x50-2*(x75-x25) | estimate > x50+2*(x75-x25)) %>%
rename(annee=valeur) %>%
distinct(cc,naiss,sexe,annee)
View(pb_effetsannee)
quantiles_effetsannee <- coeff_effets %>% filter(type=="annee" & sexe=="Ensemble") %>%
group_by(cc,naiss,sexe) %>%
nest() %>%
mutate(
ret = map(data,~quantile(x=.$estimate, probs = c(0.25,0.5,0.75) )),
ret = invoke_map(data.frame, ret)
) %>%
unnest(ret) %>% ungroup() %>%
select(-data) %>%
janitor::clean_names()
pb_effetsannee <- coeff_effets %>%
filter(type=="annee"  & sexe=="Ensemble") %>%
left_join(quantiles_effetsannee, by=c("cc","naiss","sexe")) %>%
filter(estimate < x50-2*(x75-x25) | estimate > x50+2*(x75-x25)) %>%
rename(annee=valeur) %>%
distinct(cc,naiss,sexe,annee)
View(pb_effetsannee)
reg <- "6000"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
View(pb_effetsannee)
View(tabc)
reg <- "0013"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
reg <- "0032"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
reg <- "0060"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
quantiles_effetsannee <- coeff_effets %>% filter(type=="annee" ) %>%
group_by(cc,naiss,sexe) %>%
nest() %>%
mutate(
ret = map(data,~quantile(x=.$estimate, probs = c(0.25,0.5,0.75) )),
ret = invoke_map(data.frame, ret)
) %>%
unnest(ret) %>% ungroup() %>%
select(-data) %>%
janitor::clean_names()
pb_effetsannee <- coeff_effets %>%
filter(type=="annee" ) %>%
left_join(quantiles_effetsannee, by=c("cc","naiss","sexe")) %>%
filter(estimate < x50-(x75-x25) | estimate > x50+(x75-x25)) %>%
rename(annee=valeur) %>%
mutate(cat = paste(sexe,naiss)) %>% select(-sexe,-naiss) %>%
group_by(cc,annee) %>%
summarise(nb_pb = n(),
cat_pb = paste(cat,collapse="+")) %>%
ungroup()
pb_effetsannee <- coeff_effets %>%
filter(type=="annee" ) %>%
left_join(quantiles_effetsannee, by=c("cc","naiss","sexe")) %>%
filter(estimate < x50-(x75-x25) | estimate > x50+(x75-x25)) %>%
rename(annee=valeur) %>%
mutate(cat = paste(sexe,naiss)) %>% select(-sexe,-naiss)
View(pb_effetsannee)
pb_effetsannee <- coeff_effets %>%
filter(type=="annee" ) %>%
left_join(quantiles_effetsannee, by=c("cc","naiss","sexe")) %>%
filter(estimate < x50-(x75-x25) | estimate > x50+(x75-x25)) %>%
rename(annee=valeur) %>%
mutate(cat = paste(sexe,naiss)) %>% select(-sexe,-naiss) %>%
group_by(cc,annee) %>%
summarise(nb_pb = n(),
cat_pb = paste(cat,collapse="+")) %>%
ungroup()
View(pb_effetsannee)
pb_effetsannee <- coeff_effets %>%
filter(type=="annee" ) %>%
left_join(quantiles_effetsannee, by=c("cc","naiss","sexe")) %>%
filter(estimate < x50-1.5*(x75-x25) | estimate > x50+1.5*(x75-x25)) %>%
rename(annee=valeur) %>%
mutate(cat = paste(sexe,naiss)) %>% select(-sexe,-naiss) %>%
group_by(cc,annee) %>%
summarise(nb_pb = n(),
cat_pb = paste(cat,collapse="+")) %>%
ungroup()
View(pb_effetsannee)
pb_effetsannee <- coeff_effets %>%
filter(type=="annee" ) %>%
left_join(quantiles_effetsannee, by=c("cc","naiss","sexe")) %>%
filter(estimate < x50-1.5*(x75-x25) | estimate > x50+1.5*(x75-x25)) %>%
rename(annee=valeur) %>%
#mutate(cat = paste(sexe,naiss)) %>% select(-sexe,-naiss) %>%
group_by(naiss,cc,annee) %>%
summarise(nb_pb = n(),
cat_pb = paste(sexe,collapse="+")) %>%
ungroup()
View(pb_effetsannee)
reg <- "0040"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
reg <- "0041"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
reg <- "0043"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
View(pb_effetsannee)
reg <- "0032"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
reg <- "0033"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
View(pb_effetsannee)
reg <- "0060"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
View(pb_effetsannee)
reg <- "0100"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
reg <- "0300"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
reg <- "0500"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
pb_effetsannee <- coeff_effets %>%
filter(type=="annee" ) %>%
left_join(quantiles_effetsannee, by=c("cc","naiss","sexe")) %>%
filter(estimate < x50-2*(x75-x25) | estimate > x50+2*(x75-x25)) %>%
rename(annee=valeur) %>%
#mutate(cat = paste(sexe,naiss)) %>% select(-sexe,-naiss) %>%
group_by(naiss,cc,annee) %>%
summarise(nb_pb = n(),
cat_pb = paste(sexe,collapse="+")) %>%
ungroup()
View(pb_effetsannee)
reg <- "0033"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
reg <- "0060"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
reg <- "0300"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
reg <- "0500"
coeff_effets %>% filter(cc==reg & type=="annee" ) %>% # & naiss=="Ensemble"
ggplot(aes(y=estimate,x=valeur,group=paste(sexe,naiss),linetype=naiss,colour=sexe)) +
geom_line() +
theme(legend.position="top") +
facet_grid( ~naiss) +
labs(subtitle=paste("Régime = ",reg))
View(pb_effetsannee)
filtre_an_pb <- bind_rows(
pb_effetsannee %>% filter(naiss!="France"),
pb_effetsannee %>% filter(naiss=="Ensemble")  %>% mutate(naiss="France")
) %>%
filter(nb_pb>=2) %>%
select(cc,sexe,naiss,annee)
filtre_an_pb <- bind_rows(
pb_effetsannee %>% filter(naiss!="France"),
pb_effetsannee %>% filter(naiss=="Ensemble")  %>% mutate(naiss="France")
) %>%
filter(nb_pb>=2) %>%
select(cc,naiss,annee)
View(filtre_an_pb)
agetabc <- tabc %>%
left_join(filtre_an_pb %>%
group_by(cc,naiss) %>% summarise(an_pb_max=max(annee)) %>% ungroup(),
by=c("cc","naiss")) %>%
filter(is.na(an_pb_max) | annee > an_pb_max ) %>%
# MSA : profils très bizarres (âges arrondis à l'entier ??), sauf pour les années récentes
filter(!(cc %in% c("0022","0021","Indp") & generation+age<2015))
vargen <- vargen %>%
anti_join(filtre_an_pb, by=c("cc","naiss","annee"))
vargen <- vargen %>%
mutate(annee = generation+age) %>%
anti_join(filtre_an_pb, by=c("cc","naiss","annee")) %>%
select(-annee)
effets <- vargen %>%
mutate(lvarage = log(varageliq_g_p1),
annee = factor(generation+age),
generation = factor(generation)) %>%
filter(!is.na(lvarage)) %>%
group_by(cc,sexe,naiss) %>%
filter( NROW(unique(annee))>1 & NROW(unique(generation))>1 )  %>%
ungroup() %>%
nest_by(cc,sexe,naiss) %>%
mutate(model = list(lm(lvarage ~ annee + generation, data=data) ) )
coeff_effets <- effets %>% summarise(tidy(model)) %>%
filter(grepl("[[:digit:]]$",term)) %>%
mutate(type = str_extract(term,"[^[:digit:]]+"),
valeur = str_extract(term,"[[:digit:]]+") )
quantiles_effetsannee <- coeff_effets %>% filter(type=="annee" ) %>%
group_by(cc,naiss,sexe) %>%
nest() %>%
mutate(
ret = map(data,~quantile(x=.$estimate, probs = c(0.25,0.5,0.75) )),
ret = invoke_map(data.frame, ret)
) %>%
unnest(ret) %>% ungroup() %>%
select(-data) %>%
janitor::clean_names()
pb_effetsannee <- coeff_effets %>%
filter(type=="annee" ) %>%
left_join(quantiles_effetsannee, by=c("cc","naiss","sexe")) %>%
filter(estimate < x50-2*(x75-x25) | estimate > x50+2*(x75-x25)) %>%
rename(annee=valeur) %>%
#mutate(cat = paste(sexe,naiss)) %>% select(-sexe,-naiss) %>%
group_by(naiss,cc,annee) %>%
summarise(nb_pb = n(),
cat_pb = paste(sexe,collapse="+")) %>%
ungroup() %>%
mutate(annee=as.numeric(annee))
filtre_an_pb <- bind_rows(
pb_effetsannee %>% filter(naiss!="France"),
pb_effetsannee %>% filter(naiss=="Ensemble")  %>% mutate(naiss="France")
) %>%
filter(nb_pb>=2) %>%
select(cc,naiss,annee)
View(filtre_an_pb)
agetabc <- tabc %>%
left_join(filtre_an_pb %>%
group_by(cc,naiss) %>% summarise(an_pb_max=max(annee)) %>% ungroup(),
by=c("cc","naiss")) %>%
filter(is.na(an_pb_max) | annee > an_pb_max ) %>%
# MSA : profils très bizarres (âges arrondis à l'entier ??), sauf pour les années récentes
filter(!(cc %in% c("0022","0021","Indp") & generation+age<2015))
vargen <- vargen %>%
mutate(annee = generation+age) %>%
anti_join(filtre_an_pb, by=c("cc","naiss","annee")) %>%
select(-annee) %>%
filter(!(cc %in% c("0022","0021","Indp") & generation+age<2015))
ageretr_67 <- agetabc %>% filter(age==67) %>%
full_join(vargen %>%
filter(age>=67) %>%
group_by(caisse,cc,sexe,naiss,generation) %>%
# méthode 1 = on retient l'écart observé à l'âge le plus bas observé
#filter(age==min(age)) %>%
# méthode 2 = on retient l'écart moyen sur toutes les années observées
# summarise(varageliq_g_p1 = mean(varageliq_g_p1)) %>%
# méthode 3 = on retient l'écart median sur toutes les années observées
summarise(varageliq_g_p1 = quantile(varageliq_g_p1,0.5)) %>%
ungroup() %>%
select(caisse,cc,sexe,naiss,generation,varageliq_g_p1),
by=c("caisse","cc","sexe","naiss","generation") ) %>%
arrange(caisse,cc,sexe,naiss,-generation) %>%
# on estime l'âge moyen de liquidation parmi les retraités observés à 67 ans en chaînant les évolutions d'une année sur l'autre
mutate(varageliq_g_p1 = ifelse(is.na(varageliq_g_p1),1,varageliq_g_p1),
varageliq_g_p1 = ifelse(!is.na(age),1,varageliq_g_p1),
source = ifelse(is.na(source),"chaînage rétrospectif",source)) %>%
group_by(caisse,cc,sexe,naiss) %>%
fill(ageliq,.direction="down") %>%
fill(age,.direction="down") %>%
mutate(varageliq_g_p1 = cumprod(varageliq_g_p1),
ageliq = ageliq * varageliq_g_p1 ) %>%
ungroup() %>%
select(caisse,cc,source,sexe,naiss,generation,ageliq)
# âge moyen de départ à la retraite parmi les retraités observés à 70 ans
ageretr_70 <- agetabc %>% filter(age==70) %>%
full_join(vargen %>%
filter(age>=70) %>%
group_by(caisse,cc,sexe,naiss,generation) %>%
# méthode 1 = on retient l'écart observé à l'âge le plus bas observé
#filter(age==min(age)) %>%
# méthode 2 = on retient l'écart moyen sur toutes les années observées
# summarise(varageliq_g_p1 = mean(varageliq_g_p1)) %>%
# méthode 3 = on retient l'écart median sur toutes les années observées
summarise(varageliq_g_p1 = quantile(varageliq_g_p1,0.5)) %>%
ungroup() %>%
select(caisse,cc,sexe,naiss,generation,varageliq_g_p1),
by=c("caisse","cc","sexe","naiss","generation") ) %>%
arrange(caisse,cc,sexe,naiss,-generation) %>%
# on estime l'âge moyen de liquidation parmi les retraités observés à 67 ans en chaînant les évolutions d'une année sur l'autre, observées à l'âge le plus petit disponible, par rapport à la génération la plus ancienne observée à 67 ans dans l'EACR
mutate(varageliq_g_p1 = ifelse(is.na(varageliq_g_p1),1,varageliq_g_p1),
varageliq_g_p1 = ifelse(!is.na(age),1,varageliq_g_p1),
source = ifelse(is.na(source),"chaînage rétrospectif",source)) %>%
group_by(caisse,cc,sexe,naiss) %>%
fill(ageliq,.direction="down") %>%
fill(age,.direction="down") %>%
mutate(varageliq_g_p1 = cumprod(varageliq_g_p1),
ageliq = ageliq * varageliq_g_p1 ) %>%
ungroup() %>%
select(caisse,cc,source,sexe,naiss,generation,ageliq)
# agrégation des deux tables
ageretr <- bind_rows(
ageretr_67 %>% mutate(champ_obs = "Retraités à 67 ans"),
ageretr_70 %>% mutate(champ_obs = "Retraités à 70 ans") )
ageretr %>% filter(cc=="0010" & naiss=="France") %>% ggplot(aes(y=ageliq,x=generation,colour=sexe,linetype=champ_obs,group=paste(sexe,champ_obs))) + geom_line() + labs(title="Âge moyen de départ à la retraite",caption = "Champ : retraités, nés en France.\nSource : DREES, EACR.")
ageretr %>% filter(cc=="0012" & naiss=="Ensemble") %>% ggplot(aes(y=ageliq,x=generation,colour=sexe,linetype=champ_obs,group=paste(sexe,champ_obs))) + geom_line() + labs(title="Âge moyen de départ à la retraite",caption = "Champ : retraités, tous lieux de naissance.\nSource : DREES, EACR.")
tabc %>% filter(cc=="5600" & naiss=="Ensemble") %>% ggplot(aes(y=ageliq,x=generation,colour=age,group=age)) + geom_line() + facet_grid(~sexe) + labs(title="Âge moyen de départ à la retraite, selon l'âge d'observation",caption = "Champ : nés en France.\nSource : DREES, EACR.")
ageretr %>% filter(cc %in% c("0010","0015") & naiss=="Ensemble" & champ_obs=="Retraités à 67 ans") %>% ggplot(aes(y=ageliq,x=generation,colour=sexe,linetype=cc,group=paste(sexe,cc))) + geom_line() + labs(title="Âge moyen de départ à la retraite",caption = "Champ : retraités, nés en France.\nSource : DREES, EACR.")
ageretr %>% filter(cc %in% c("6000","5600") & naiss=="Ensemble" & champ_obs=="Retraités à 67 ans") %>% ggplot(aes(y=ageliq,x=generation,colour=sexe,linetype=cc,group=paste(sexe,cc))) + geom_line() + labs(title="Âge moyen de départ à la retraite",caption = "Champ : retraités, nés en France.\nSource : DREES, EACR.")
ageretr %>% filter(cc %in% c("0010","0015","0042") & naiss=="Ensemble" & champ_obs=="Retraités à 67 ans") %>% ggplot(aes(y=ageliq,x=generation,colour=sexe,linetype=cc,group=paste(sexe,cc))) + geom_line() + facet_grid(~sexe) + labs(title="Âge moyen de départ à la retraite",caption = "Champ : retraités, nés en France.\nSource : DREES, EACR.")
