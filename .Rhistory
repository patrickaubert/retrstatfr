# docs_cor <- docs_cor_
View(docs_cor)
docs_cor <- docs_cor_brut %>%
rename(titre_complet = titre) %>%
mutate(type = case_when(
grepl("^Document",titre_complet) ~ "document",
grepl("^Note de présentation générale",titre_complet) ~ "document",
grepl("^Annexe",titre_complet) ~ "document",
grepl("^Diaporama",titre_complet) ~ "diaporama",
grepl("^Présentation",titre_complet) ~ "diaporama",
grepl("^(Le d|D)ossier en bref",titre_complet) ~ "dossier en bref",
grepl("\\.(xlsx|xls)$",url.doc) ~ "fichier excel",
grepl("\\.(pptx|ppt)$",url.doc) ~ "diaporama"   ),
# correction du cas où la 2e partie du titre est dans la ligne auteur
titre_complet = ifelse(grepl("^[[:lower:]]",auteur),paste(titre_complet,auteur),titre_complet),
auteur = ifelse(grepl("^[[:lower:]]",auteur),NA,auteur),
# extraction du n° de document
titre = titre_complet %>%
str_replace_all("\\\t"," ") %>%
str_replace("(?<=(Diaporama|Document)( n[°[:space:][:digit:]\\.]{0,6}| N[°[:space:][:digit:]\\.]{0,6}|))[[:space:]](?=[[:upper:]][[:lower:]]+)"," - ") %>%
str_replace_all(" \\- ","#"),
num_document = titre %>% str_extract("^([[:digit:]]+(_|#)|)(Document|Diaporama)[^#]*(?=(#|$))"),
titre = titre %>%
str_replace("^([[:digit:]]+(_|#)|)(Document|Diaporama)[^#]*(#|$)","") %>%
str_replace_all("#"," - ")
#num_document = titre_complet %>%
#  str_extract("^([[:digit:]]+_|)(Document|Diaporama)( n| N|)[°[:space:][:digit:]\\-\\.]*([Bb]is|)(?=($|[[:space:]]\\-[[:space:]]))"),
#titre = titre_complet %>%
#  str_replace("^([[:digit:]]+_|)(Document|Diaporama)( n| N|)[°[:space:][:digit:]\\-\\.]*([Bb]is|)(|[[:space:]]\\-[[:space:]])","")
)
verif <- docs_cor %>% filter(grepl("[Dd](iaporama|ocument)",titre))
verif <- docs_cor %>% filter(grepl("^[[:lower:]]",auteur))
verif <- docs_cor %>% filter(is.na(type))
View(verif)
verif$url.seance[40]
urlloc <- verif$url.seance[40]
pagedocs <- read_html( paste0(urlcor,urlloc) )
# -- première lecture : pages "standards" avec des boutons pour le téléchargement des PDF
#champ.a.extraire <- "h4,h6,span,a,p"
champ.a.extraire <- ".panel__title,.media__file_author,.action__btn,.btn,.field h4,.field__item p,.field__item a,.field__item span"
page.docs <- data.frame(
txt = pagedocs %>%  html_nodes(champ.a.extraire) %>% html_text() %>% trimws(),
ref = pagedocs %>%  html_nodes(champ.a.extraire) %>% html_attr("href"),
type = pagedocs %>%  html_nodes(champ.a.extraire) %>% html_attr("class")
) %>%
#distinct() %>%
mutate(txt = ifelse(txt=="Lien de téléchargement",ref,txt) %>%
str_replace_all("[[:space:]]+"," "),
type = case_when(
#type=="field__item" & grepl("^[IVX]+[[:space:]]*(\\.|\\-|–)",txt ~  "partie",
grepl("^field",type) ~  "partie",
is.na(type) ~ "txt",
TRUE ~  type) ) %>%
filter(!grepl("^Lien",txt),txt!="Accueil",txt!="") %>%
select(-ref)
View(page.docs)
(!("panel__title" %in% unique(page.docs$type)))
texte.introductif <- (page.docs %>% filter(type=="txt",txt!="",txt!=" ") )$txt %>% paste(collapse="\n")
if (texte.introductif=="") {
autrestxts <- pagedocs %>%  html_nodes(".field__item") %>% html_text() %>% trimws() %>%
data.frame() %>%
filter(!(. %in% c(""," ")))
texte.introductif <- autrestxts$.[1]
}
texte.introductif
page.docs <- page.docs %>%
filter(type %in% c("panel__title","media__file_author","action__btn","partie")) %>%
mutate(type = type %>% recode("panel__title" = "titre",
"media__file_author" = "auteur",
"action__btn" = "url.doc",
"partie" = "partie"),
seance = page.seances$titre.seance[i],
date.seance = page.seances$date.seance[i],
url.seance = page.seances$url.seance[i],
annee = page.seances$annee[i],
mois = page.seances$mois[i],
jour = page.seances$jour[i],
texte.introductif = texte.introductif,
mots.cles = mots.cles)
docs_cor <- docs_cor_brut %>%
rename(titre_complet = titre) %>%
mutate(type = case_when(
grepl("^Document",titre_complet) ~ "document",
grepl("^Note de présentation générale",titre_complet) ~ "document",
grepl("^Annexe",titre_complet) ~ "document",
grepl("^Diaporama",titre_complet) ~ "diaporama",
grepl("^Présentation",titre_complet) ~ "diaporama",
grepl("^(Le d|D)ossier en bref",titre_complet) ~ "dossier en bref",
grepl("\\.(xlsx|xls)$",url.doc) ~ "fichier excel",
grepl("\\.(pptx|ppt)$",url.doc) ~ "diaporama" ,
grepl("^Dossier complet$",titre_complet) ~ "dossier complet"),
# correction du cas où la 2e partie du titre est dans la ligne auteur
titre_complet = ifelse(grepl("^[[:lower:]]",auteur),paste(titre_complet,auteur),titre_complet),
auteur = ifelse(grepl("^[[:lower:]]",auteur),NA,auteur),
# extraction du n° de document
titre = titre_complet %>%
str_replace_all("\\\t"," ") %>%
str_replace("(?<=(Diaporama|Document)( n[°[:space:][:digit:]\\.]{0,6}| N[°[:space:][:digit:]\\.]{0,6}|))[[:space:]](?=[[:upper:]][[:lower:]]+)"," - ") %>%
str_replace_all(" \\- ","#"),
num_document = titre %>% str_extract("^([[:digit:]]+(_|#)|)(Document|Diaporama)[^#]*(?=(#|$))"),
titre = titre %>%
str_replace("^([[:digit:]]+(_|#)|)(Document|Diaporama)[^#]*(#|$)","") %>%
str_replace_all("#"," - ")
#num_document = titre_complet %>%
#  str_extract("^([[:digit:]]+_|)(Document|Diaporama)( n| N|)[°[:space:][:digit:]\\-\\.]*([Bb]is|)(?=($|[[:space:]]\\-[[:space:]]))"),
#titre = titre_complet %>%
#  str_replace("^([[:digit:]]+_|)(Document|Diaporama)( n| N|)[°[:space:][:digit:]\\-\\.]*([Bb]is|)(|[[:space:]]\\-[[:space:]])","")
)
textes.seances <- docs_cor_brut %>%
select(annee,mois,jour,url.seance,texte.introductif,mots.cles) %>%
distinct()
seances_cor <- page.seances %>%
select(-nb) %>%
left_join(textes.seances ,   by=c("annee","mois","jour","url.seance"))
seances_cor <- page.seances %>%
left_join(textes.seances ,   by=c("annee","mois","jour","url.seance"))
View(seances_cor)
textes.seances.retrouves <- seances_cor %>% filter(!is.na(texte.introductif))
textes.seances.missing <- seances_cor %>% filter(is.na(texte.introductif))
compl.seances <- do.call("bind_rows",lapply(textes.seances.missing$url.seance,infoseance)) %>%
distinct()
View(compl.seances)
seances_cor <- bind_rows(
textes.seances.retrouves,
textes.seances.missing %>%
select(-texte.introductif,-mots.cles) %>%
left_join(compl.seances, by="url.seance")
)
View(seances_cor)
usethis::use_data(docs_cor,
seances_cor,
overwrite=TRUE)
write.csv2(seances_cor,
file=gzfile("data-raw/seances_cor.csv.gz"),
#"data-raw/seances_cor.csv",
row.names = FALSE, fileEncoding = "UTF-8")
docs_cor_ <- docs_cor
# docs_cor <- docs_cor_
pdf_page1 <- function(pdf){
tmp <- tempfile()
on.exit(unlink(tmp))
tempfile <- pdftools::pdf_subset(pdf, tmp, pages = 1)
#pdftools::pdf_text(tmp)
pdftools::pdf_text(tempfile)
}
info_pdf_page1 <- function(urlloc) {
#lextrait <- list()
#for (i in c(1:NROW(urls))) {
#urlloc<-urls[i]
page1 <- pdf_page1(pdf = paste0(urlcor,urlloc))
txtpage1 <- page1 %>%
str_replace_all("[\\\n][[:space:]]*(?=Secrétariat général du (Conseil|COR))","\n\n") %>%
str_replace_all("[\\\n][[:space:]]*(?=Séance plénière du (Conseil|COR))","\n\n") %>%
str_replace_all("[\\\n]{2,}","\n\n") %>%
str_replace_all("[\\\n]{2,}[[:space:]]*(?=[[:lower:]])"," ") %>%
strsplit(split="\n\n") %>% unlist() %>%
str_replace_all("[[:space:]\\\n]+"," ") %>%
trimws()
tabpage1 <- data.frame(info = txtpage1[!(txtpage1 %in% c("","1"))]) %>%
filter(!grepl("^[[:space:][:punct:][:digit:]]+$",info),
nchar(info)<=500)
if (nrow(tabpage1)==0) {return(data.frame() )}
if (nrow(tabpage1)>=1) {
tabpage1 <- tabpage1  %>%
mutate(info = info %>% str_replace("[[:space:]]*Document de travail, n’engage pas le Conseil",""),
nbligne = 1:n(),
nominfo = case_when(
grepl("^CONSEIL D(’|')ORIENTATION DES RETRAITES",info) ~ "seance_dapres_pdf",
grepl("^Conseil d(’|')orientation des retraites (Réunion|Séance) plénière",info) ~ "seance_dapres_pdf",
grepl("^Séance plénière[[:alpha:][:space:]]+[[:digit:]]+ [[:alpha:]]+ 20[[:digit:]]{2}",info) ~ "seance_dapres_pdf",
grepl("^([IVX[:space:]\\-]+|)Document (n|N)",info) ~ "numdocument_dapres_pdf",
grepl("^(Document|Annexe) [[:digit:]\\.]+$",info) ~ "numdocument_dapres_pdf",
grepl("^((Le |)[[:digit:]]{1,2} |)(janvier|février|mars|avril|mai|juin|juillet|août|septembre|octobre|novembre|décembre) 20[[:digit:]]{2}",tolower(info)) ~ "date_dapres_pdf",
grepl("^Le dossier en bref Préparé par le secrétariat général du Conseil",info) ~ "titre_dapres_pdf"
),
nbinfo = sum(is.na(nominfo)),
ranginfovide = cumsum(is.na(nominfo)),
nominfo = case_when(
!is.na(nominfo) ~ nominfo,
(nbinfo==2 & ranginfovide==1 & is.na(nominfo)) ~ "titre_dapres_pdf",
(nbinfo==2 & ranginfovide==2 & is.na(nominfo)) ~ "auteur_dapres_pdf"
) ) %>%
select(-nbligne) %>%
group_by(nominfo) %>% mutate(nb=paste0("info",1:n())) %>% ungroup() %>%
mutate(nominfo = ifelse(is.na(nominfo),nb,nominfo)) %>%
pivot_wider(id_cols="nbinfo",names_from="nominfo",values_from="info",values_fn = function(x){paste(x,collapse = " / ")}) %>%
mutate(url.doc = urlloc )
return(tabpage1)
}
#lextrait[[i]] <- tabpage1
}
urls <- (docs_cor %>%
filter(is.na(type) | !(type %in% c("dossier en bref","diaporama"))) %>%
filter(grepl("pdf$",url.doc)))$url.doc
# essai <- do.call("bind_rows",lapply(urls[268:277],info_pdf_page1))
extrait_info_page1 <- do.call("bind_rows",lapply(urls,info_pdf_page1))
View(extrait_info_page1)
verif <- extrait_info_page1 %>% filter(!is.na(titre_dapres_pdf))
View(verif)
names(extrait_info_page1) %>% paste(collapse=",")
View(docs_cor)
docs_cor <- docs_cor %>%
full_join(extrait_info_page1 %>%
filter(!is.na(titre_dapres_pdf)) %>%
select(seance_dapres_pdf,numdocument_dapres_pdf,titre_dapres_pdf,auteur_dapres_pdf,url.doc),
by="url.doc") %>%
mutate(titre = case_when(
if.na(titre) ~ titre_dapres_pdf,
grepl("^Document[[:space:]]*(n°|N°|)[[:space:]]*[[:digit:]\\.\\-IVX]([Bb]is|)$",titre)  ~ titre_dapres_pdf,
TRUE ~ titre),
num_document = case_when(
!is.na(num_document) ~ num_document,
TRUE ~ numdocument_dapres_pdf     ),
type = case_when(
!is.na(type) ~ type,
grepl("^Document",titre) ~ "document",
grepl("^Note de présentation générale",titre) ~ "document",
grepl("^Annexe",titre) ~ "document",
grepl("^Diaporama",titre) ~ "diaporama",
grepl("^Présentation",titre) ~ "diaporama",
grepl("^(Le d|D)ossier en bref",titre) ~ "dossier en bref",
grepl("^Dossier complet$",titre) ~ "dossier complet")
)
docs_cor <- docs_cor %>%
full_join(extrait_info_page1 %>%
filter(!is.na(titre_dapres_pdf)) %>%
select(seance_dapres_pdf,numdocument_dapres_pdf,titre_dapres_pdf,auteur_dapres_pdf,url.doc),
by="url.doc") %>%
mutate(titre = case_when(
is.na(titre) ~ titre_dapres_pdf,
grepl("^Document[[:space:]]*(n°|N°|)[[:space:]]*[[:digit:]\\.\\-IVX]([Bb]is|)$",titre)  ~ titre_dapres_pdf,
TRUE ~ titre),
num_document = case_when(
!is.na(num_document) ~ num_document,
TRUE ~ numdocument_dapres_pdf     ),
type = case_when(
!is.na(type) ~ type,
grepl("^Document",titre) ~ "document",
grepl("^Note de présentation générale",titre) ~ "document",
grepl("^Annexe",titre) ~ "document",
grepl("^Diaporama",titre) ~ "diaporama",
grepl("^Présentation",titre) ~ "diaporama",
grepl("^(Le d|D)ossier en bref",titre) ~ "dossier en bref",
grepl("^Dossier complet$",titre) ~ "dossier complet")
)
grepl("^Document[[:space:]]*(n°|N°|)[[:space:]]*[[:digit:]\\.\\-IVX]+([Bb]is|)$","Document n°3")
grepl("^Document[[:space:]]*(n°|N°|)[[:space:]]*[[:digit:]\\.\\-IVX]+$","Document n°3")
grepl("^Document[[:space:]]*(n°|N°|)[[:space:]]*$","Document n°3")
grepl("^Document[[:space:]]*(n°|N°|)[[:space:]]*[[:digit:]\\.\\-]+$","Document n°3")
grepl("^Document[[:space:]]*(n°|N°|)[[:space:]]*[[:digit:]\\.\\-IVX]+$","Document n°3")
grepl("^Document[[:space:]]*(n°|N°|)[[:space:]]*[[:digit:]IVX\\.\\-]+$","Document n°3")
docs_cor <- docs_cor %>%
full_join(extrait_info_page1 %>%
filter(!is.na(titre_dapres_pdf)) %>%
select(seance_dapres_pdf,numdocument_dapres_pdf,titre_dapres_pdf,auteur_dapres_pdf,url.doc),
by="url.doc") %>%
mutate(titre = case_when(
is.na(titre) ~ titre_dapres_pdf,
grepl("^[Dd]ocument[[:space:]]*(n°|N°|)[[:space:]]*[[:digit:]IVX\\.\\-]+([Bb]is|)$",titre)  ~ titre_dapres_pdf,
TRUE ~ titre),
num_document = case_when(
!is.na(num_document) ~ num_document,
TRUE ~ numdocument_dapres_pdf     ),
type = case_when(
!is.na(type) ~ type,
grepl("^Document",titre) ~ "document",
grepl("^Note de présentation générale",titre) ~ "document",
grepl("^Annexe",titre) ~ "document",
grepl("^Diaporama",titre) ~ "diaporama",
grepl("^Présentation",titre) ~ "diaporama",
grepl("^(Le d|D)ossier en bref",titre) ~ "dossier en bref",
grepl("^Dossier complet$",titre) ~ "dossier complet")
)
docs_cor <- docs_cor_
verif <- docs_cor %>% filter(grepl("Etats",titre))
View(verif)
docs_cor <- docs_cor %>%
full_join(extrait_info_page1 %>%
filter(!is.na(titre_dapres_pdf)) %>%
select(seance_dapres_pdf,numdocument_dapres_pdf,titre_dapres_pdf,auteur_dapres_pdf,url.doc),
by="url.doc") %>%
mutate(titre = case_when(
is.na(titre) | titre=="" ~ titre_dapres_pdf,
titre == "- Etats-Unis" ~ titre_dapres_pdf,
grepl("^[Dd]ocument[[:space:]]*(n°|N°|)[[:space:]]*[[:digit:]IVX\\.\\-]+([Bb]is|)$",titre)  ~ titre_dapres_pdf,
TRUE ~ titre),
num_document = case_when(
!is.na(num_document) ~ num_document,
TRUE ~ numdocument_dapres_pdf     ),
auteur = case_when(
auteur == "- Italie" ~ titre_dapres_pdf,
!is.na(auteur) & auteur!="" ~ auteur,
TRUE ~ auteur_dapres_pdf     ),
type = case_when(
!is.na(type) ~ type,
grepl("^Document",titre) ~ "document",
grepl("^Note de présentation générale",titre) ~ "document",
grepl("^Annexe",titre) ~ "document",
grepl("^Diaporama",titre) ~ "diaporama",
grepl("^Présentation",titre) ~ "diaporama",
grepl("^(Le d|D)ossier en bref",titre) ~ "dossier en bref",
grepl("^Dossier complet$",titre) ~ "dossier complet")
)
verif <- docs_cor %>% filter(is.na(type))
View(docs_cor)
View(verif)
docs_cor <- docs_cor_
docs_cor <- docs_cor %>%
full_join(extrait_info_page1 %>%
filter(!is.na(titre_dapres_pdf)) %>%
select(seance_dapres_pdf,numdocument_dapres_pdf,titre_dapres_pdf,auteur_dapres_pdf,url.doc),
by="url.doc") %>%
mutate(titre = case_when(
is.na(titre) | titre=="" ~ titre_dapres_pdf,
titre == "- Etats-Unis" ~ titre_dapres_pdf,
grepl("^[Dd]ocument[[:space:]]*(n°|N°|)[[:space:]]*[[:digit:]IVX\\.\\-]+([Bb]is|)$",titre)  ~ titre_dapres_pdf,
TRUE ~ titre),
num_document = case_when(
!is.na(num_document) ~ num_document,
TRUE ~ numdocument_dapres_pdf     ),
auteur = case_when(
auteur == "- Italie" ~ titre_dapres_pdf,
!is.na(auteur) & auteur!="" ~ auteur,
TRUE ~ auteur_dapres_pdf     ),
type = case_when(
!is.na(type) ~ type,
grepl("^Document",titre) ~ "document",
grepl("^Note de présentation générale",titre) ~ "document",
grepl("^Annexe",titre) ~ "document",
grepl("^Diaporama",titre) ~ "diaporama",
grepl("^Présentation",titre) ~ "diaporama",
grepl("^(Le d|D)ossier en bref",titre) ~ "dossier en bref",
grepl("^Dossier complet$",titre) ~ "dossier complet",
grepl("^Document",num_document) ~ "document",
grepl("^Présentations",partie) ~ "diaporama")
)
verif <- docs_cor %>% filter(is.na(type))
View(verif)
verif$url.doc[63]
docs_cor <- docs_cor_
docs_cor <- docs_cor %>%
full_join(extrait_info_page1 %>%
filter(!is.na(titre_dapres_pdf)) %>%
select(seance_dapres_pdf,numdocument_dapres_pdf,titre_dapres_pdf,auteur_dapres_pdf,url.doc),
by="url.doc") %>%
mutate(titre = case_when(
is.na(titre) | titre=="" ~ titre_dapres_pdf,
titre == "- Etats-Unis" ~ titre_dapres_pdf,
grepl("^[Dd]ocument[[:space:]]*(n°|N°|)[[:space:]]*[[:digit:]IVX\\.\\-]+([Bb]is|)$",titre)  ~ titre_dapres_pdf,
TRUE ~ titre),
num_document = case_when(
!is.na(num_document) ~ num_document,
TRUE ~ numdocument_dapres_pdf     ),
auteur = case_when(
auteur == "- Italie" ~ titre_dapres_pdf,
!is.na(auteur) & auteur!="" ~ auteur,
TRUE ~ auteur_dapres_pdf     ),
type = case_when(
!is.na(type) ~ type,
grepl("^Document",titre) ~ "document",
grepl("^Note de présentation générale",titre) ~ "document",
grepl("^Annexe",titre) ~ "document",
grepl("^Diaporama",titre) ~ "diaporama",
grepl("^Présentation",titre) ~ "diaporama",
grepl('^("[Ll]e [dD]|[Ll]e [dD]|D)ossier en bref',titre) ~ "dossier en bref",
grepl("^Dossier complet$",titre) ~ "dossier complet",
grepl("^Document",num_document) ~ "document",
grepl("^Présentations",partie) ~ "diaporama")
)
verif <- docs_cor %>% filter(is.na(type))
View(verif)
verif <- docs_cor %>% filter(is.na(titre) | titre=="")
View(verif)
verif <- docs_cor %>% filter(is.na(titre) | titre=="") %>% select(url.doc,titre_complet) %>% left_join(extrait_info_page1, by="url.doc")
View(verif)
docs_cor <- docs_cor_
docs_cor <- docs_cor %>%
full_join(extrait_info_page1 %>%
filter(!is.na(titre_dapres_pdf)) %>%
select(seance_dapres_pdf,numdocument_dapres_pdf,titre_dapres_pdf,auteur_dapres_pdf,url.doc),
by="url.doc") %>%
mutate(titre = case_when(
is.na(titre) | titre=="" ~ titre_dapres_pdf,
titre == "- Etats-Unis" ~ titre_dapres_pdf,
grepl("^[Dd]ocument[[:space:]]*(n°|N°|)[[:space:]]*[[:digit:]IVX\\.\\-]+([Bb]is|)$",titre)  ~ titre_dapres_pdf,
TRUE ~ titre),
num_document = case_when(
!is.na(num_document) ~ num_document,
TRUE ~ numdocument_dapres_pdf     ),
auteur = case_when(
auteur == "- Italie" ~ titre_dapres_pdf,
!is.na(auteur) & auteur!="" ~ auteur,
TRUE ~ auteur_dapres_pdf     ),
type = case_when(
!is.na(type) ~ type,
grepl("^Document",titre) ~ "document",
grepl("^Note de présentation générale",titre) ~ "document",
grepl("^Annexe",titre) ~ "document",
grepl("^Diaporama",titre) ~ "diaporama",
grepl("^Présentation",titre) ~ "diaporama",
grepl('^("[Ll]e [dD]|[Ll]e [dD]|D)ossier en bref',titre) ~ "dossier en bref",
grepl("^Dossier complet$",titre) ~ "dossier complet",
grepl("^Document",num_document) ~ "document",
grepl("^Présentations",partie) ~ "diaporama")
)
textes.seances <- docs_cor_brut %>%
select(annee,mois,jour,url.seance,texte.introductif,mots.cles) %>%
distinct()
seances_cor <- page.seances %>%
left_join(textes.seances ,   by=c("annee","mois","jour","url.seance"))
textes.seances.retrouves <- seances_cor %>% filter(!is.na(texte.introductif))
textes.seances.missing <- seances_cor %>% filter(is.na(texte.introductif))
compl.seances <- do.call("bind_rows",lapply(textes.seances.missing$url.seance,infoseance)) %>%
distinct()
seances_cor <- bind_rows(
textes.seances.retrouves,
textes.seances.missing %>%
select(-texte.introductif,-mots.cles) %>%
left_join(compl.seances, by="url.seance")
)
usethis::use_data(docs_cor,
seances_cor,
overwrite=TRUE)
write.csv2(seances_cor,
file=gzfile("data-raw/seances_cor.csv.gz"),
#"data-raw/seances_cor.csv",
row.names = FALSE, fileEncoding = "UTF-8")
write.csv2(docs_cor %>% select(-texte.introductif,-mots.cles),
file=gzfile("data-raw/docs_cor.csv.gz"),
#"data-raw/docs_cor.csv",
row.names = FALSE, fileEncoding = "UTF-8")
basedossiers <- docs_cor %>% filter(type=="dossier en bref")
# urlloc <- basedossiers$url.doc[9]
extrait_question_dossierenbref <- function(urlloc) {
#for (i in 1:nrow(basedossiers)) {
#urlloc <- basedossiers$url.doc[i]
txt <- pdftools::pdf_text(paste0("https://www.cor-retraites.fr",urlloc) ) %>% paste(collapse=" ")
if (!grepl("",txt)) { return(data.frame() )}
txt <- txt %>%
str_replace_all("\n[[:space:]]*[[:digit:]]\n","\n") %>%
str_replace_all("","\n\n") %>%
str_replace_all("(?<=Pourquoi ce (dossier|sujet)( |)\\?)[\\\n[:space:]]+"," ") %>%
strsplit(split="\n\n") %>% unlist() %>%
str_replace_all("[[:space:]\\\n]+"," ") %>%
trimws()
tab <- data.frame(info = txt[!(txt %in% c("","1"))]) %>%
filter(!grepl("^[[:space:][:punct:][:digit:]]+$",info)) %>%
mutate(nligne = 1:n(),
type = case_when(
grepl("^[IVX]+(\\.|–| –|\\-| \\-) ",info) ~ "partie",
grepl("\\?",info) & (nligne>1) ~ "question",
TRUE ~ "autre"    ),
nbpartie = cumsum(type=="partie"),
nbquestion = cumsum(type=="question"))  %>%
filter(!(type=="autre" & nligne>2)) %>% select(-nligne) %>%
pivot_wider(id_cols=-c("type","info"),names_from="type",values_from="info",values_fn = function(x){paste(x,collapse = " / ")}) %>%
fill(c("autre","partie"),.direction="down") %>%
mutate(url.doc = urlloc ) %>%
filter(!is.na(question)) %>%
select(-nbpartie,-nbquestion)
return(tab)
}
extrait_dossiers_en_bref <- do.call("bind_rows",lapply(basedossiers$url.doc,extrait_question_dossierenbref))
dossiers_en_bref <- extrait_dossiers_en_bref %>%
mutate(partie = ifelse(is.na(partie) & grepl("^Pourquoi ce (dossier|sujet)",question),"Pourquoi ce dossier ?",partie),
date.seance = autre %>% str_extract("Séance[^«]+(?=«)"),
titre.seance = autre %>% str_extract("(?<=«)[^»]+(?=»)") %>% trimws(),
reponse = question %>% str_replace("^[^\\?]+\\?","") %>% trimws(),
question = question %>% str_extract("^[^\\?]+\\?")   ) %>%
select(-autre)
basereponses <- dossiers_en_bref %>% select(url.doc,reponse) %>%
mutate(reponse_avec_url = reponse %>%
str_replace_all("(?<=documents n°[[:space:][:digit:]\\.]{1,6}(et|\\&)[[:space:]]{0,2})(?=(n°|[[:digit:]]))","#") %>%
str_replace_all("(?<=document(s|) n°[[:space:][:digit:]\\.]{0,6}[:digit:])(?=[^[:digit:]])","#") %>%
str_replace_all("(?=(D|d)ocument(s|) n°)","#") %>%
str_replace_all("(?<=#(n°|n° |)[[:digit:]]{1,2})","#") )
eclate_reponse <- function(i){
eclate <- basereponses$reponse_avec_url[i] %>% strsplit(split="#") %>% unlist()
data.frame(
url.doc = rep(basereponses$url.doc[i],NROW(eclate)),
reponse = rep(basereponses$reponse[i],NROW(eclate)),
reponse_avec_url = eclate
) %>% return()
}
basereponses_ <- do.call("bind_rows",lapply(1:nrow(basereponses),eclate_reponse)) %>%
mutate(num_document = reponse_avec_url %>%
str_replace("^documents","document") %>%
str_replace("(?=^[[:digit:]])","document n° ")) %>%
left_join(docs_cor %>% select(url.doc,annee,mois,jour), by="url.doc")
liens <- docs_cor %>%
select(url.doc,num_document,annee,mois,jour) %>%
filter(!is.na(num_document)) %>%
rename(url.lien = url.doc) %>%
mutate(num_document = tolower(num_document))
basereponses_ <- basereponses_ %>%
left_join(liens, by=c("annee","mois","jour","num_document")) %>%
mutate(reponse_avec_url = ifelse(
!is.na(url.lien),
paste0("[",reponse_avec_url,"](https://www.cor-retraites.fr",url.lien,")"),
reponse_avec_url
)) %>%
select(-url.lien,-num_document,-annee,-mois,-jour) %>%
group_by(url.doc,reponse) %>% summarise_all(function(x){paste(x,collapse="")}) %>% ungroup()
dossiers_en_bref <- dossiers_en_bref %>%
left_join(basereponses_, by=c("url.doc","reponse"))
View(dossiers_en_bref)
usethis::use_data(dossiers_en_bref_cor,       overwrite=TRUE)
dossiers_en_bref_cor <- dossiers_en_bref
usethis::use_data(dossiers_en_bref_cor,       overwrite=TRUE)
write.csv2(dossiers_en_bref_cor,
file=gzfile("data-raw/dossiers_en_bref_cor.csv.gz"),
row.names = FALSE, fileEncoding = "UTF-8")
